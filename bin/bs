#!/usr/bin/env ruby

require 'yaml'
require 'pp'

#TODO: normalize gem paths
require './lib/bs'
require './lib/bs/task'
require './lib/bs/config'

cli_struct = {
  'task' => {
    'list'   => 'Bs::Task.list',
    'add'    =>  {'.+' => 'Bs::Task.add'},
    'del'    =>  {'.+' => 'Bs::Task.del'},
    "verify" =>  {'*' => 'Bs::Task.verify'}
  },
  "subsystem" => {
    "list"    => 'Bs::Subsysytem.list'
  },
  "sandbox"  => {
    'make'   => 'make_sandbox',
    'del'    => 'del_sandbox',
    'status' => 'dump_sandbox'
  }
}

def print_usage
  puts 'Usage:'
  puts '  bs task list'
  puts '  bs task add [git URL]'
  puts '  bs task del [task name]'
  puts ''
  puts '  bs sandbox status'
  puts '  bs sandbox make'
  puts '  bs sandbox del'
end

def quit_on_wrong_input
  print_usage
  exit(1)
end

def make_sandbox
  node = Node::Local.new
  node.destroy
  node.create
end

def del_sandbox
   Node::Local.new.destroy
end

def dump_sandbox
   Node::Local.new.is_sane?
end

def parse_arguments struct
  params = []
  while (struct && (arg = ARGV.shift)) do
    struct = struct[arg]
    while (struct.is_a?(Hash) && struct.keys[0] == '.+') do
      argv = ARGV.shift
      quit_on_wrong_input unless /.+/.match(argv)
      params.push(argv)
      struct = struct['.+']
    end
  end

  if struct 
    eval "#{struct} params"
  else
    quit_on_wrong_input
  end
end

if ARGV.empty?
  # TODO: interactive CLI
  print_usage
else
  parse_arguments cli_struct
end

